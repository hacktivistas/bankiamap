yepnope([{load:"http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js",complete:function(){if(!window.jQuery){yepnope("lib/jquery/jquery.js")}}},{load:"lib/leaflet/leaflet-bankia.js",complete:function(){dibujaMapa()}}]);var galleta={nueva:function(name,value,days){if(days){var date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);var expires="; expires="+date.toGMTString()}else var expires="";document.cookie=name+"="+value+expires+"; path=/"},leer:function(name){var nameEQ=name+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" ")c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length)}return null},borrar:function(name){galleta.nueva(name,"",-1)}};function dibujaMapa(){var mapa=L.map("mapa",{attributionControl:false}).setView([40.46,-3.75],5);L.tileLayer("http://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(mapa);var bankias=L.geoCsv(null,{onEachFeature:function(feature,layer){var idnum=feature.properties[bankias.getPropertyName("idnum")],direccion=feature.properties[bankias.getPropertyName("Dirección")],cp=feature.properties[bankias.getPropertyName("Código postal")],localidad=feature.properties[bankias.getPropertyName("Localidad")],tf=feature.properties[bankias.getPropertyName("Teléfono")],appfb="https://graph.facebook.com/oauth/authorize?client_id=147793798720673&redirect_uri=http%3A%2F%2Fforos.toqueabankia.net%2Fentry%2Fconnect%2Ffacebook%3FTarget%3D%252F&scope=email,publish_stream",urlforo="http://foros.toqueabankia.net/entry/register?Target=categories/"+idnum+"-"+tf,popup="";popup+="<b>Oficina Nº "+idnum+"</b><br><br>";popup+=direccion+"<br>";popup+=cp+" "+localidad+"<br>";popup+="Tf: "+tf+"<br><br>";popup+='<div class="participa"><p>Pulsa en uno de los dos<br>botones para registrarte</p><p><a href="'+appfb+'" class="boton" target="_blank">facebook</a></p><p><a href="'+urlforo+'" class="boton" target="_blank">e-mail</a></p></div>';layer.bindPopup(popup)},pointToLayer:function(feature,latlng){return L.marker(latlng,{icon:L.icon({iconUrl:"images/marcador-bankia.png",shadowUrl:"images/marker-shadow.png",iconSize:[25,41],shadowSize:[41,41],shadowAnchor:[13,20]})})},firstLineTitles:true});$.ajax({type:"GET",dataType:"text",url:"data/bankias.csv",error:function(){alert("No se pudieron cargar los datos")},success:function(csv){bankias.addData(csv);var cluster=new L.MarkerClusterGroup;cluster.addLayer(bankias);mapa.addLayer(cluster);var pos=galleta.leer("posicionMapa");if(pos==null){mapa.fitBounds(cluster.getBounds())}else{pos=pos.split("&");if(pos.length==3){if(confirm("¿Quiere continuar navegando por el mapa desde el punto que lo dejó?")){mapa.setView([parseFloat(pos[0]),parseFloat(pos[1])],parseInt(pos[2]))}else{mapa.fitBounds(cluster.getBounds())}}}},complete:function(){$("#cargando").fadeOut("slow")}});$("#localizame").click(function(e){mapa.locate();$("#localizame").text("Localizando...");mapa.on("locationfound",function(e){mapa.setView(e.latlng,15);$("#localizame").text("Bankias cercanos")})});window.onbeforeunload=function(){var centro=mapa.getCenter(),zoom=mapa.getZoom();galleta.nueva("posicionMapa",centro.lat+"&"+centro.lng+"&"+zoom,10)}}